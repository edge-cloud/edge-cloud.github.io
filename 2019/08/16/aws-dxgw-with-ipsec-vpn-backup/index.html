<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>AWS Transit Gateway with Direct Connect Gateway and Site-to-Site (IPSec) VPN Backup - Edge Cloud</title>
<meta name="description" content="This article shows you how to setup a primary active Direct Connect connection between an AWS Transit Gateway and on-premises networks via Direct Connect Gateway, while leveraging a Site-to-Site (IPSec) VPN as backup.">


  <meta name="author" content="Christian Elsen">
  
  <meta property="article:author" content="Christian Elsen">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Edge Cloud">
<meta property="og:title" content="AWS Transit Gateway with Direct Connect Gateway and Site-to-Site (IPSec) VPN Backup">
<meta property="og:url" content="https://www.edge-cloud.net/2019/08/16/aws-dxgw-with-ipsec-vpn-backup/">


  <meta property="og:description" content="This article shows you how to setup a primary active Direct Connect connection between an AWS Transit Gateway and on-premises networks via Direct Connect Gateway, while leveraging a Site-to-Site (IPSec) VPN as backup.">



  <meta property="og:image" content="https://www.edge-cloud.net/assets/images/og-image.jpg">





  <meta property="article:published_time" content="2019-08-16T00:00:00-07:00">





  

  


<link rel="canonical" href="https://www.edge-cloud.net/2019/08/16/aws-dxgw-with-ipsec-vpn-backup/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Christian Elsen",
      "url": "https://www.edge-cloud.net/",
      "sameAs": ["https://www.linkedin.com/in/christianelsen/"]
    
  }
</script>


  <meta name="google-site-verification" content="ZPKuOb9ie7OuRgxLoRK2REKxFW6bC0_7VaNFcTNQQxM" />






<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Edge Cloud Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link href="/assets/css/fontawesome/css/all.min.css" rel="stylesheet">
<noscript><link rel="stylesheet" href="/assets/css/fontawesome/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
<link rel="manifest" href="/assets/images/site.webmanifest">
<link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/images/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/images/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<link rel="preload" href="/assets/js/main.min.js" as="script">
<link rel="preload" href="/assets/js/lazysizes.min.js" as="script">
<link rel="preload" href="/assets/js/instantsearch/dist/instantsearch.min.js" as="script">

<link rel="preload" href="/assets/css/main.css" as="style">
<link rel="preload" href="/assets/js/instantsearch/dist/instantsearch.min.css" as="style">
<link rel="preload" href="/assets/js/instantsearch/dist/instantsearch-theme-algolia.min.css" as="style">

<link rel="dns-prefetch" href="https://www.google-analytics.com">
<link rel="dns-prefetch" href="https://googleads.g.doubleclick.net">
<link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
<link rel="dns-prefetch" href="https://adservice.google.com">
<link rel="dns-prefetch" href="http://5xvqigedj8-dsn.algolia.net">

<link rel="preconnnect" href="https://www.google-analytics.com">
<link rel="preconnnect" href="https://googleads.g.doubleclick.net">
<link rel="preconnnect" href="https://pagead2.googlesyndication.com">
<link rel="preconnnect" href="https://adservice.google.com">
<link rel="preconnnect" href="https://5xvqigedj8-dsn.algolia.net">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/edgecloud.png" alt=" On the edge of cloud computing"></a>
        
        <a class="site-title" href="/">
           On the edge of cloud computing
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/#aws">AWS</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/#ipv6">IPv6</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
<li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.edge-cloud.net/">
        <img src="/assets/images/chriselsen.jpg" alt="Christian Elsen" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.edge-cloud.net/" itemprop="url">Christian Elsen</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Technology Generalist</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">About</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://www.newzealand.com/int/te-anau/" rel="nofollow noopener noreferrer me noopener noreferrer" itemprop="sameAs" target="_blank"><i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i><span class="label">Aotearoa</span></a></li>
          
        
          
            <li><a href="https://chris.elsen.xyz" rel="nofollow noopener noreferrer me noopener noreferrer" itemprop="sameAs" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://noc.social/@chriselsen" rel="nofollow noopener noreferrer me noopener noreferrer" itemprop="sameAs" target="_blank"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/christianelsen/" rel="nofollow noopener noreferrer me noopener noreferrer" itemprop="sameAs" target="_blank"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/chriselsen/" rel="nofollow noopener noreferrer me noopener noreferrer" itemprop="sameAs" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://as213151.net/" rel="nofollow noopener noreferrer me noopener noreferrer" itemprop="sameAs" target="_blank"><i class="fas fa-fw fa-network-wired" aria-hidden="true"></i><span class="label">AS213151</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="AWS Transit Gateway with Direct Connect Gateway and Site-to-Site (IPSec) VPN Backup">
    <meta itemprop="description" content="This article shows you how to setup a primary active Direct Connect connection between an AWS Transit Gateway and on-premises networks via Direct Connect Gateway, while leveraging a Site-to-Site (IPSec) VPN as backup.">
    <meta itemprop="datePublished" content="2019-08-16T00:00:00-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://www.edge-cloud.net/2019/08/16/aws-dxgw-with-ipsec-vpn-backup/" class="u-url" itemprop="url">AWS Transit Gateway with Direct Connect Gateway and Site-to-Site (IPSec) VPN Backup
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-08-16T00:00:00-07:00">August 16, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    

    <span class="page__meta-sep"></span>

    
    <span class="page__meta-tags"></span>
      <i class="fas fa-tags" aria-hidden="true"></i>  
      #AWS, #Network, #Direct-Connect, #VPN
    
    
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
<li><a href="#desired-architecture">Desired Architecture</a></li>
<li>
<a href="#actual-asymmetric-routing">Actual asymmetric routing</a><ul>
<li><a href="#as-path-length">AS path length</a></li>
<li><a href="#multi-exit-discriminator-med">Multi Exit Discriminator (MED)</a></li>
<li><a href="#tgw-preference-of-dx-over-vpn">TGW preference of DX over VPN</a></li>
<li><a href="#more-specific-routes">More Specific Routes</a></li>
</ul>
</li>
<li>
<a href="#corrected-traffic-flow">Corrected traffic flow</a><ul><li><a href="#route-summarization-and-filtering">Route summarization and filtering</a></li></ul>
</li>
<li><a href="#results">Results</a></li>
<li><a href="#word-of-warning">Word of Warning</a></li>
<li><a href="#summary">Summary</a></li>
</ul>

            </nav>
          </aside>
        
        <p>A very common network architecture pattern on AWS is to deploy an <a href="https://docs.aws.amazon.com/vpn/latest/s2svpn/VPC_VPN.html" target="_blank" rel="noopener noreferrer">AWS Site-to-Site (IPSec) VPN</a> connection as the backup for an <a href="https://aws.amazon.com/directconnect/" target="_blank" rel="noopener noreferrer">AWS Direct Connect (DX)</a> connection between on-premises networks and AWS VPCs.
With the introduction of <a href="https://aws.amazon.com/transit-gateway/" target="_blank" rel="noopener noreferrer">AWS Transit Gateway</a> and <a href="https://docs.aws.amazon.com/directconnect/latest/UserGuide/direct-connect-gateways.html" target="_blank" rel="noopener noreferrer">AWS Direct Connect Gateway</a>, this architecture pattern is no longer a trivial task.
This blog post highlights the associated challenges and offers a solution using BGP route summarization and BGP prefix filtering to manage traffic over the Direct Connect and Site-to-Site (IPSec) VPN path as expected.</p>

<h1 id="desired-architecture">Desired Architecture</h1>

<p>To highlight the challenges with this architecture pattern, we assume the AWS network architecture as outlined in Figure 1.</p>

<figure class="">








<a href="/content/uploads/2019/08/DXGW_with_VPN-Backup_Desired.png" title="Figure 1: Desired Setup with Direct Connect Gateway as the primary active path and Site-to-Site (IPSec) VPN as the backup path. " class="image-popup">
<picture>
  <source width="881" height="451" type="image/webp" data-srcset="        /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-320.webp 320w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-384.webp 384w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-512.webp 512w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-683.webp 683w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-800.webp 800w,  /content/uploads/2019/08/DXGW_with_VPN-Backup_Desired.webp 881w" sizes="881px"></source>
  <source width="881" height="451" data-srcset="    /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-320.png 320w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-384.png 384w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-512.png 512w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-683.png 683w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Desired-800.png 800w,  /content/uploads/2019/08/DXGW_with_VPN-Backup_Desired.png 881w" sizes="881px"></source>
  <img src="/content/resized/2019/08/DXGW_with_VPN-Backup_Desired-320.png" data-src="/content/uploads/2019/08/DXGW_with_VPN-Backup_Desired.png" class="blur-up lazyautosizes lazyload" width="881" height="451" alt="Figure 1: Desired Setup with Direct Connect Gateway as the primary active path and Site-to-Site (IPSec) VPN as the backup path. ">
</picture>
</a>



  <figcaption>Figure 1: Desired Setup with Direct Connect Gateway as the primary active path and Site-to-Site (IPSec) VPN as the backup path.
</figcaption>

</figure>

<p>This architecture includes the following assumptions and design decisions:</p>
<ul>
  <li>
<strong>VPC Prefixes:</strong> Within AWS we assume that each of the four VPCs is configured with a single /24 prefix.</li>
  <li>
<strong>DX Gateway announced prefixes:</strong> As the number of prefixes  per AWS Transit Gateway from AWS to on-premises on a transit virtual interface (via Direct Connect Connect Gateway) is limited to 20, we will announce a single /16 summary route for the VPC prefixes.</li>
  <li>
<strong>Site-to-Site (IPSec) VPN over Internet or DX Public VIF:</strong> The backup path via the Site-to-Site (IPSec) VPN tunnels will either leverage the Internet or a <a href="https://docs.aws.amazon.com/directconnect/latest/UserGuide/create-vif.html#create-public-vif" target="_blank" rel="noopener noreferrer">Direct Connect Public Virtual interface</a> connection as transport mechanism.</li>
  <li>
<strong>Equal Cost Multi-Pathing (ECMP):</strong> A single AWS Site-to-Site (IPSec) VPN tunnel only provides a maximum bandwidth of 1.25 Gbps. For the case that the primary active DX connection has a bandwidth higher than 1 Gbps this could lead to contention during a failover scenario. Therefore we want to leverage multiple VPN tunnels with ECMP to provide sufficient throughputs over the backup path.</li>
  <li>
<strong>Direct Connect as primary active path:</strong> as Direct Connect offers a more consistent network experience than Internet-based connections, this network path is desired to be the primary active path, while the Site-to-Site (IPSec) VPN path should solely serve as the standby backup path.</li>
  <li>
<strong>BGP as failover mechanism:</strong> We want to leverage BGP as the failover mechanism and not implement any manual out-of-band monitoring and failover mechanism. As such we will be using a BGP based Site-to-Site (IPSec) VPN.</li>
  <li>
<strong>IPv6 failover support:</strong> AWS Site-to-Site (IPSec) VPN does <a href="https://www.edge-cloud.net/2020/09/11/aws-ipsec-vpn-ipv6/">support carrying IPv6 traffic over IPv4 based IPSec tunnels</a>. Therefore this failover design is also applicable for the use cases, where you want to carry private IPv6 traffic between on-premises and AWS.</li>
</ul>

<p class="notice--info"><strong>Note:</strong> The design in Figure 1 depicts solely a single DX connection as well as a single Site-to-Site (IPSec) VPN tunnel. A more realistic setup would include two DX connections, as well as a pair of VPN tunnels. As the presented challenges and proposed solution are the same for both designs, the simplified version is used here to better explain the concepts.</p>

<h1 id="actual-asymmetric-routing">Actual asymmetric routing</h1>

<p>Unfortunately when implementing the above design, you’ll quickly notice that the result is not what you were expecting. Instead you will observe asymmetric routing (See Figure 2) with traffic from AWS to on-premises traversing - as desired - the Direct Connect link, while traffic from on-premises to AWS traversing the Site-to-Site (IPSec) VPN tunnel instead.</p>

<figure class="">








<a href="/content/uploads/2019/08/DXGW_with_VPN-Backup_Actual.png" title="Figure 2: Actual asymmetric routing due to more specific prefixes being propagated over the Site-to-Site (IPSec) VPN. " class="image-popup">
<picture>
  <source width="881" height="549" type="image/webp" data-srcset="        /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-320.webp 320w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-384.webp 384w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-512.webp 512w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-683.webp 683w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-800.webp 800w,  /content/uploads/2019/08/DXGW_with_VPN-Backup_Actual.webp 881w" sizes="881px"></source>
  <source width="881" height="549" data-srcset="    /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-320.png 320w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-384.png 384w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-512.png 512w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-683.png 683w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Actual-800.png 800w,  /content/uploads/2019/08/DXGW_with_VPN-Backup_Actual.png 881w" sizes="881px"></source>
  <img src="/content/resized/2019/08/DXGW_with_VPN-Backup_Actual-320.png" data-src="/content/uploads/2019/08/DXGW_with_VPN-Backup_Actual.png" class="blur-up lazyautosizes lazyload" width="881" height="549" alt="Figure 2: Actual asymmetric routing due to more specific prefixes being propagated over the Site-to-Site (IPSec) VPN. ">
</picture>
</a>



  <figcaption>Figure 2: Actual asymmetric routing due to more specific prefixes being propagated over the Site-to-Site (IPSec) VPN.
</figcaption>

</figure>

<p>For traffic from on-premises to AWS, a few challenges cause this traffic to traverse the Site-to-Site (VPN) VPN connection instead of the AWS Direct Connect link. The following sections will dive into these challenges in more detail:</p>

<h2 id="as-path-length">AS path length</h2>

<p>When looking from the customer router at the CIDR(s) announced via BGP from the AWS Direct Connect Gateway, we would expect to see them with an ASN path of 65001 and 64512, therefore with a path length of two. Instead we will only see the ASN 65001 of the AWS Direct Connect Gateway in the path.
This is the result of users manually setting the CIDRs to be announced by the AWS Direct Connect Gateway towards on-premises. Imagine the AWS Direct Connect Gateway effectively filtering out any CIDRs learned from the AWS Transit Gateway and instead originates a route with the manually configured CIDR.
The result is a reduced path length to one over Direct Connect, which is the same AS path length as over the Site-to-Site (IPSec) VPN link.</p>

<h2 id="multi-exit-discriminator-med">Multi Exit Discriminator (MED)</h2>

<p>We might end up in a situation where the same prefix is being announced over the Direct Connect link as well as the VPN link with the same AS path length. In case Equal Cost Multipathing (ECMP) is configured on the customer router, we would expect both of these path to be considered at the same time.
To combat this behavior AWS sets a Multi Exit Discriminator (MED) value of 100 on BGP sessions over VPN links. As this value is higher than the default value of 0 - which the DX path uses - the DX path should be preferred. This works well in the case DX and VPN are used with a Virtual Private Gateway (VGW) as the same AS is announced over both connections.
But with the TGW the Direct Connect path uses a different ASN compared to the VPN path. Therefore the MED value is only taken into consideration if the setting <em>“bgp always-compare-med”</em> is used within the customer’s router. With this setting MED is always compared if multiple routes to a destination have the same local preference and AS path length.</p>

<h2 id="tgw-preference-of-dx-over-vpn">TGW preference of DX over VPN</h2>

<p>The AS path received by the AWS Transit Gateway is not reduced to the path length of one by the BGP configuration. This results in a longer path length over the Direct Connect Gateway link as over the Site-to-Site (IPSec) VPN link. Nevertheless, traffic will solely traverses over the Direct Connect link to on-premises. The AWS Transit Gateway in this case prefers the AWS Direct Connect gateway over the VPN connection, as outlined in the <a href="https://docs.aws.amazon.com/vpc/latest/tgw/how-transit-gateways-work.html#tgw-routing-overview" target="_blank" rel="noopener noreferrer">AWS Transit Gateway documentation</a>.
You can imagine the AWS Transit Gateway setting a higher “local preference” (LOCAL_PREF) on the AWS Direct Connect gateway BGP sessions.</p>

<h2 id="more-specific-routes">More Specific Routes</h2>

<p>The AWS Transit Gateway will announce all active static routes and propagated routes over the Site-to-Site (IPSec) VPN link, which in this example results in four /24 prefixes being announced towards the customer routers. As mentioned before, due to the limitation on the number of prefixes per AWS Transit Gateway from AWS to on-premise on a transit virtual interface (via Direct Connect Connect Gateway), we are announcing a /16 summary route instead of the four /24 routes over the AWS Direct Connect Gateway.
As a result the customer router will see more specific routes over the Site-to-Site (IPSec) VPN link and therefore prefer this link for traffic towards the VPCs. Obviously this is not what we have desired.</p>

<h1 id="corrected-traffic-flow">Corrected traffic flow</h1>

<p>To correct the asymmetric routing situation we need to implement a few changes as highlighted in Figure 3.</p>

<figure class="">








<a href="/content/uploads/2019/08/DXGW_with_VPN-Backup_Fix.png" title="Figure 3: Corrected traffic flow after using route summarization and prefix filtering. " class="image-popup">
<picture>
  <source width="921" height="675" type="image/webp" data-srcset="        /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-320.webp 320w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-384.webp 384w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-512.webp 512w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-683.webp 683w,         /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-800.webp 800w,  /content/uploads/2019/08/DXGW_with_VPN-Backup_Fix.webp 921w" sizes="921px"></source>
  <source width="921" height="675" data-srcset="    /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-320.png 320w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-384.png 384w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-512.png 512w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-683.png 683w,     /content/resized/2019/08/DXGW_with_VPN-Backup_Fix-800.png 800w,  /content/uploads/2019/08/DXGW_with_VPN-Backup_Fix.png 921w" sizes="921px"></source>
  <img src="/content/resized/2019/08/DXGW_with_VPN-Backup_Fix-320.png" data-src="/content/uploads/2019/08/DXGW_with_VPN-Backup_Fix.png" class="blur-up lazyautosizes lazyload" width="921" height="675" alt="Figure 3: Corrected traffic flow after using route summarization and prefix filtering. ">
</picture>
</a>



  <figcaption>Figure 3: Corrected traffic flow after using route summarization and prefix filtering.
</figcaption>

</figure>

<p>The following sections look at these required changes in detail:</p>

<h2 id="route-summarization-and-filtering">Route summarization and filtering</h2>

<p>I already covered how to implement BGP route summarization with the AWS Transit Gateway in a <a href="https://www.edge-cloud.net/2019/08/07/bgp-route-summary-with-tgw/">previous post</a>.
In this example we assume that VPCs 1 - 4 are using the CIDRs 10.1.1.0/24, 10.1.2.0/24, 10.1.3.0/24, and 10.1.4.0/24 respectively. Because we are propagating the summary prefix of 10.1.0.0/16 over the Direct Connect link, we want to send the same summary prefix over the Site-to-Site (IPSec) VPN.</p>

<p>As outlined in the <a href="https://www.edge-cloud.net/2019/08/07/bgp-route-summary-with-tgw/">previous post</a> we can achieve this by creating a static route for the prefix 10.1.0.0/16 and point it to e.g. VPC 1.</p>

<p>Now the customer gateway will receive the summary route of 10.1.0.0/16 along with the more specific routes of 10.1.1.0/24, 10.1.2.0/24, 10.1.3.0/24, and 10.1.4.0/24. Using prefix filtering on the customer gateway, we can filter out the more specific routes and solely install the summary route into the BGP route table.</p>

<p>The below example shows how to implement this under Cisco IOS with route-maps.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>router bgp 65100
 bgp log-neighbor-changes
 neighbor 169.254.254.1 remote-as 64512
 neighbor 169.254.254.1 description Direct Connect
 neighbor 169.254.254.1 timers 10 30 30
 neighbor 169.254.254.1 password 0 mypassword
 neighbor 169.254.15.221 remote-as 65001
 neighbor 169.254.15.221 description VPN
 neighbor 169.254.15.221 timers 10 30 30
 !
 address-family ipv4
  network 10.2.0.0 mask 255.255.0.0
  neighbor 169.254.254.1 activate
  neighbor 169.254.254.1 soft-reconfiguration inbound
  neighbor 169.254.15.221 activate
  neighbor 169.254.15.221 soft-reconfiguration inbound
  neighbor 169.254.15.221 route-map SUM_FILTER in
  maximum-paths 4
 exit-address-family
!

ip prefix-list incoming seq 5 permit 10.1.0.0/16
!
route-map SUM_FILTER permit 10
 match ip address prefix-list incoming
!
</code></pre></div></div>

<p>In this case we only allow the summary prefix of 10.1.0.0/16 over the VPN link.</p>

<h1 id="results">Results</h1>

<p>At this point we are done and have succeeded: The customer gateway will see the same summary route announced with the same AS path length over Direct Connect and VPN link, except that the route over VPN will have an MED of 100. Therefore the DX route - having an MED of 0 - will be chosen instead.</p>

<p>With this we can look at the routes that are received from the BGP peer over DX (here: 169.254.254.1) and the BGP peer over VPN (here: 169.254.15.221)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#sh ip bgp neighbors 169.254.254.1 received-routes | beg Network
      Network          Next Hop            Metric LocPrf Weight Path
  *    10.1.0.0/16     169.254.254.1                          0 65001 i

#sh ip bgp neighbors 169.254.15.221 received-routes | beg Network
      Network          Next Hop            Metric LocPrf Weight Path
  *    10.1.0.0/16     169.254.15.221         100             0 64512 i
  *    10.1.1.0/24     169.254.15.221         100             0 64512 i
  *    10.1.2.0/24     169.254.15.221         100             0 64512 i
  *    10.1.3.0/24     169.254.15.221         100             0 64512 i
  *    10.1.4.0/24     169.254.15.221         100             0 64512 i
</code></pre></div></div>
<p>While we see the four more specific /24 routes over VPN - which will be filtered out - we also see the summary route matching the route over DX. While both routes have the same AS path length, we can see the difference in Metric (showing MED).</p>

<p>With this the route installed into the RIB by BGP will solely be the one traversing DX.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#sh ip bgp | beg Network
      Network          Next Hop            Metric LocPrf Weight Path
  *    10.1.0.0/16     169.254.15.221         100             0 64512 i
  *&gt;                   169.254.254.1            0             0 65001 i
</code></pre></div></div>

<h1 id="word-of-warning">Word of Warning</h1>

<p>The fundamental underlying principle of this approach is to have the same IP CIDRs with the same AS path length announced over both Direct Connect and VPN. Having a more specific CIDR announced over one of the two paths, would shift traffic towards this path. With that you might be tempted to announce more specific routes from the Transit Gateway over the Direct Connect Gateway into on-premises, than what is sent over VPN. While this approach is technically possible, it will very quickly bring you within the service limit of 20 prefixes that can be announced from a Transit Gateway to a Direct Connect Gateway.</p>

<h1 id="summary">Summary</h1>

<p>This article walked you through the challenges associated with configuring a Site-to-Site (IPSec) VPN tunnel as a backup path with a primary active traffic between an AWS Transit Gateway and on-premises networks via a Direct Connect Gateway.
To overcome these challenges a solution is proposed that leverages BGP route summarization and BGP prefix filtering.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#aws" class="page__taxonomy-item p-category" rel="tag">AWS</a><span class="sep">, </span>
    
      <a href="/tags/#direct-connect" class="page__taxonomy-item p-category" rel="tag">Direct-Connect</a><span class="sep">, </span>
    
      <a href="/tags/#network" class="page__taxonomy-item p-category" rel="tag">Network</a><span class="sep">, </span>
    
      <a href="/tags/#vpn" class="page__taxonomy-item p-category" rel="tag">VPN</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2019-08-16T00:00:00-07:00">August 16, 2019</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://toot.kytta.dev/?text=AWS%20Transit%20Gateway%20with%20Direct%20Connect%20Gateway%20and%20Site-to-Site%20(IPSec)%20VPN%20Backup%0Ahttps://www.edge-cloud.net/2019/08/16/aws-dxgw-with-ipsec-vpn-backup/" class="btn btn--mastodon" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Mastodon" target="_blank" rel="noopener noreferrer">  
    <i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span> Mastodon</span></a>

  <a href="https://twitter.com/intent/tweet?text=AWS+Transit+Gateway+with+Direct+Connect+Gateway+and+Site-to-Site+%28IPSec%29+VPN+Backup%20https%3A%2F%2Fwww.edge-cloud.net%2F2019%2F08%2F16%2Faws-dxgw-with-ipsec-vpn-backup%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter" target="_blank" rel="noopener noreferrer">
    <i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.edge-cloud.net%2F2019%2F08%2F16%2Faws-dxgw-with-ipsec-vpn-backup%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook" target="_blank" rel="noopener noreferrer">
    <i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.edge-cloud.net%2F2019%2F08%2F16%2Faws-dxgw-with-ipsec-vpn-backup%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn" target="_blank" rel="noopener noreferrer">
    <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>

  <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.edge-cloud.net%2F2019%2F08%2F16%2Faws-dxgw-with-ipsec-vpn-backup%2F&amp;title=AWS+Transit+Gateway+with+Direct+Connect+Gateway+and+Site-to-Site+%28IPSec%29+VPN+Backup" class="btn btn--reddit" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" target="_blank" rel="noopener noreferrer">
    <i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

  <a href="https://getpocket.com/save?url=https%3A%2F%2Fwww.edge-cloud.net%2F2019%2F08%2F16%2Faws-dxgw-with-ipsec-vpn-backup%2F&amp;title=AWS+Transit+Gateway+with+Direct+Connect+Gateway+and+Site-to-Site+%28IPSec%29+VPN+Backup" class="btn share-button btn--pocket" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Pocket" target="_blank" rel="noopener noreferrer">
    <i class="fab fa-fw fa-get-pocket" aria-hidden="true"></i><span> Pocket</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/2019/08/07/bgp-route-summary-with-tgw/" class="pagination--pager" title="BGP route summarization with AWS Transit Gateway
">Previous</a>
    
    
      <a href="/2019/09/06/dx-gateway-deep-dive/" class="pagination--pager" title="AWS Direct Connect Gateway Deep Dive
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/06/18/r53-random-prefix-attack-mitigation/" rel="permalink">Random prefix attack mitigation with Amazon Route 53
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-06-18T00:00:00-07:00">June 18, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    

    <span class="page__meta-sep"></span>

    
    <span class="page__meta-tags"></span>
      <i class="fas fa-fw fa-tags" aria-hidden="true"></i>  
      #AWS, #Network, #Route-53
    
    
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">How to mitigate random prefix attacks - when someone send a lot of traffic to subdomains of your main domain - with Amazon Route 53
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/03/20/http-redirect-with-cloudfront/" rel="permalink">URL Redirect with Amazon CloudFront and Amazon Route 53
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-03-20T00:00:00-07:00">March 20, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    

    <span class="page__meta-sep"></span>

    
    <span class="page__meta-tags"></span>
      <i class="fas fa-fw fa-tags" aria-hidden="true"></i>  
      #AWS, #Network, #CloudFront, #Web
    
    
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">How to use Amazon CloudFront and Amazon Route 53 to perform a URL redirect, e.g. from http://about.example.com to http://www.example.com/about.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2022/07/19/hands-on-with-aws-byoip/" rel="permalink">Hands-on with AWS Bring your own IP addresses (BYOIP) in Amazon EC2
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-07-19T00:00:00-07:00">July 19, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          20 minute read
        
      </span>
    

    <span class="page__meta-sep"></span>

    
    <span class="page__meta-tags"></span>
      <i class="fas fa-fw fa-tags" aria-hidden="true"></i>  
      #AWS, #Network, #IPv6
    
    
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Using AWS Bring your own IP addresses (BYOIP) in Amazon EC2 capability with a real life example of an IPv6 prefix, showing provisioning and troubleshooting s...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2022/06/28/dx-overview/" rel="permalink">AWS Direct Connect overview
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-06-28T00:00:00-07:00">June 28, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    

    <span class="page__meta-sep"></span>

    
    <span class="page__meta-tags"></span>
      <i class="fas fa-fw fa-tags" aria-hidden="true"></i>  
      #AWS, #Network, #Direct-Connect
    
    
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Overview of AWS Direct Connect, with which you can establish private connectivity between AWS and your data center, office, factory or collocated environment.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<script src="/assets/js/instantsearch/dist/instantsearch.min.js"></script>
  <div class="search-searchbar"></div>
  <div class="search-hits"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div align="center" class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://noc.social/@chriselsen" rel="me nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/christianelsen/" rel="me nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://github.com/chriselsen/" rel="me nofollow noopener noreferrer noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div align="center" class="page__footer-copyright">© 2013 - 2023 Christian Elsen. <a href="/terms/">Terms &amp; Privacy Policy</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="/assets/js/lazysizes.min.js"></script>

  



<!-- Including InstantSearch.js library and styling -->
<script async src="/assets/js/instantsearch/dist/instantsearch.min.js"></script>
<link rel="stylesheet" href="/assets/js/instantsearch/dist/instantsearch.min.css">
<link rel="stylesheet" href="/assets/js/instantsearch/dist/instantsearch-theme-algolia.min.css">

<script>
// Instanciating InstantSearch.js with Algolia credentials
const search = instantsearch({
  appId: '5XVQIGEDJ8',
  apiKey: '4e0733cbaacd194a6cf59b61024f966f',
  indexName: 'edge-cloud-net',
  searchParameters: {
    restrictSearchableAttributes: [
      'title',
      'content'
    ]
  }
});

const hitTemplate = function(hit) {
  const url = hit.url;
  const hightlight = hit._highlightResult;
  const title = hightlight.title && hightlight.title.value  || "";
  const content = hightlight.html && hightlight.html.value  || "";

  return `
    <div class="list__item">
      <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
        <h2 class="archive__item-title" itemprop="headline"><a href="${url}">${title}</a></h2>
        <div class="archive__item-excerpt" itemprop="description">${content}</div>
      </article>
    </div>
  `;
}

// Adding searchbar and results widgets
search.addWidget(
  instantsearch.widgets.searchBox({
    container: '.search-searchbar',
    poweredBy: true,
    placeholder: 'Enter your search term...'
  })
);
search.addWidget(
  instantsearch.widgets.hits({
    container: '.search-hits',
    templates: {
      item: hitTemplate,
      empty: 'No results',
    }
  })
);

// Starting the search
search.start();
</script>





    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'edge-cloud/www.edge-cloud.net');
    script.setAttribute('issue-term', 'pathname');
    
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
